---
title: C_11. é¢å‘æ¥å£ç¼–ç¨‹
date: 2020-05-04
categories: C
---

## 1 ç”²æ–¹æ¡†æ¶
æŠ½è±¡ç³»ç»Ÿæ•´ä½“æ¡†æ¶ï¼Œèƒ½è‡ªç”±é›†æˆä¹™æ–¹çš„äº§å“

```c
#include <stdio.h>
#include <stdlib.h>

// å‡½æ•°æŒ‡é’ˆ
// åˆå§‹åŒ–æ¸¸æˆ
// void **:åˆ›å»ºç©å®¶(ç”³è¯·void *)
typedef void(*INIT_GAME)(void **player, char *name);
// æˆ˜æ–— èƒœåˆ©è¿”å›1ï¼Œå¤±è´¥è¿”å›0
typedef int(*FIGHT_GAME)(void *player, int gameDiff);
// æŸ¥çœ‹ç©å®¶ä¿¡æ¯
typedef void(*PRINT_GAME)(void *player);
// ç¦»å¼€æ¸¸æˆ
typedef void(*EXIT_GAME)(void *player);

void playGame(INIT_GAME init, FIGHT_GAME fight, PRINT_GAME printGame, EXIT_GAME exitGame) {
	void *player = NULL;
	char name[64] = "";
	printf("è¯·è¾“å…¥ç©å®¶å§“åï¼š");
	scanf("%s", name);
	getchar();  // åƒæ‰è¾“å…¥æµï¼ˆç¼“å†²åŒºï¼‰çš„å›è½¦
	// åˆå§‹åŒ–æ¸¸æˆ
	init(&player, name);
	
	int diff = -1;
	while (1) {
		system("clear");  // æ¸…å±
		
		printf("è¯·é€‰æ‹©æ¸¸æˆéš¾åº¦ï¼ˆ1:ç®€å• 2:æ™®é€š 3:å›°éš¾ï¼‰ï¼š");
		scanf("%d", &diff);
		// æˆ˜æ–—
		int ret = fight(player, diff);
		if (ret) {
			printf("æˆ˜æ–—èƒœåˆ©ï¼\n");
			printGame(player);
		} else {
			printf("ğŸ‘ä½ æ­»äº†");
			break;
		}
	}
	// é€€å‡ºæ¸¸æˆ
	exitGame(player);	
}




int main(int argc, char *argv[]) {
	playGame(INIT_GAME, FIGHT_GAME, PRINT_GAME, EXIT_GAME);
	return 0;
}
```

## 2 ä¹™æ–¹æ¥å£
èƒ½å¤Ÿä¸ç”²æ–¹æ¡†æ¶å®Œç¾å¯¹æ¥

```c
// company.h
#ifndef JIAFANG_H
#define JIAFANG_H

#include <stdio.h>
#include <string.h>
#include <stdlib.h>

struct Player {
	char name[64];
	int level;
	int exp;
};

// åˆå§‹åŒ–æ¸¸æˆ
// void **:åˆ›å»ºç©å®¶(ç”³è¯·void *)
void init_game(void **p, char *name);
// æˆ˜æ–— èƒœåˆ©è¿”å›1ï¼Œå¤±è´¥è¿”å›0
int fight(void *player, int gameDiff);
// æŸ¥çœ‹ç©å®¶ä¿¡æ¯
void print_player(void *player);
// ç¦»å¼€æ¸¸æˆ
void exit_game(void *player);

// åˆ¤æ–­ç©å®¶æ˜¯å¦èƒœåˆ©ï¼Œè¿”å›è·å¾—ç»éªŒå€¼
int isWin(int winRate, int expRate);

#endif
```

```c
// company.c
#include "company.h"

// åˆå§‹åŒ–æ¸¸æˆ
// void **:åˆ›å»ºç©å®¶(ç”³è¯·void *)
void init_game(void **p, char *name) {
	struct Player *player = (struct Player *)malloc(sizeof(struct Player));
	strcpy(player->name, name);
	player->level = 0;
	player->exp = 0;
	*p = player;
}

// æˆ˜æ–— èƒœåˆ©åŠ ç»éªŒå¹¶è¿”å›1ï¼Œå¤±è´¥è¿”å›0
int fight(void *player, int gameDiff) {
	struct Player *p = player;
	int add_exp = 0;
	switch (gameDiff) {
		case 1:
			add_exp = isWin(90, 1);
			break;
		case 2:
			add_exp = isWin(50, 2);
			break;
		case 3:
			add_exp = isWin(30, 3);
			break;
		default:
			break;
	}
	p->exp += add_exp;
	p->level = p->exp / 10;
	
	if (add_exp) {
		return 1;
	} else {
		return 0;
	}
}
// åˆ¤æ–­ç©å®¶æ˜¯å¦èƒœåˆ©ï¼Œè¿”å›è·å¾—ç»éªŒå€¼
int isWin(int winRate, int expRate) {
	int radom = rand()%100+1;  // 1-100
	if (radom <= winRate) {
		return expRate*10;
	} else {
		return 0;
	}
}

// æŸ¥çœ‹ç©å®¶ä¿¡æ¯
void print_player(void *player) {
	struct Player *p = player;
	printf("ç©å®¶å§“åï¼š%s\n", p->name);
	printf("ç©å®¶ç­‰çº§ï¼š%d\n", p->level);
	printf("ç©å®¶ç»éªŒï¼š%d\n", p->exp);
}

// ç¦»å¼€æ¸¸æˆ
void exit_game(void *player) {
	if (player == NULL) {
		return;
	}
	free(player);
	player = NULL;
}
```

## 3 åŒæ–¹å¯¹æ¥

```c
#include <stdio.h>
#include <stdlib.h>
#include "company.h"

// å‡½æ•°æŒ‡é’ˆ
// åˆå§‹åŒ–æ¸¸æˆ
// void **:åˆ›å»ºç©å®¶(ç”³è¯·void *)
typedef void(*INIT_GAME)(void **player, char *name);
// æˆ˜æ–— èƒœåˆ©è¿”å›1ï¼Œå¤±è´¥è¿”å›0
typedef int(*FIGHT_GAME)(void *player, int gameDiff);
// æŸ¥çœ‹ç©å®¶ä¿¡æ¯
typedef void(*PRINT_GAME)(void *player);
// ç¦»å¼€æ¸¸æˆ
typedef void(*EXIT_GAME)(void *player);

void playGame(INIT_GAME init, FIGHT_GAME fight, PRINT_GAME printGame, EXIT_GAME exitGame) {
	void *player = NULL;
	char name[64] = "";
	printf("è¯·è¾“å…¥ç©å®¶å§“åï¼š");
	scanf("%s", name);
	getchar();  // åƒæ‰è¾“å…¥æµï¼ˆç¼“å†²åŒºï¼‰çš„å›è½¦
	// åˆå§‹åŒ–æ¸¸æˆ
	init(&player, name);
	
	int diff = -1;
	while (1) {
		system("clear");  // æ¸…å±
		
		printf("è¯·é€‰æ‹©æ¸¸æˆéš¾åº¦ï¼ˆ1:ç®€å• 2:æ™®é€š 3:å›°éš¾ï¼‰ï¼š");
		scanf("%d", &diff);
		// æˆ˜æ–—
		int ret = fight(player, diff);
		if (ret) {
			printf("æˆ˜æ–—èƒœåˆ©ï¼\n");
			printGame(player);
		} else {
			printf("ğŸ‘ä½ æ­»äº†");
			break;
		}
	}
	// é€€å‡ºæ¸¸æˆ
	exitGame(player);	
}

int main(int argc, char *argv[]) {
	playGame(init_game, fight, print_player, exit_game);
	return 0;
}
```